// tools/douyinCookie.js
const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');
const readline = require('readline');

const COOKIE_DIR = path.resolve(__dirname, '../cookies');
const COOKIE_FILE = path.join(COOKIE_DIR, 'douyin.txt');

function toNetscapeCookie(cookies) {
    const lines = [
        '# Netscape HTTP Cookie File',
        '# Generated by puppeteer',
        ''
    ];

    for (const c of cookies) {
        const domain = c.domain.startsWith('.') ? c.domain : '.' + c.domain;
        const flag = domain.startsWith('.') ? 'TRUE' : 'FALSE';
        const secure = c.secure ? 'TRUE' : 'FALSE';
        const expiry = c.expires > 0 ? Math.floor(c.expires) : 1893456000;

        lines.push([
            domain,
            flag,
            c.path || '/',
            secure,
            expiry,
            c.name,
            c.value
        ].join('\t'));
    }

    return lines.join('\n');
}

function waitEnter() {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    return new Promise(resolve => {
        rl.question('\nâœ… å·²æ‰«ç å¹¶ç¡®è®¤ç™»å½•åï¼ŒæŒ‰å›è½¦å¯¼å‡º Cookie...\n', () => {
            rl.close();
            resolve();
        });
    });
}

(async () => {
    if (!fs.existsSync(COOKIE_DIR)) {
        fs.mkdirSync(COOKIE_DIR, { recursive: true });
    }

    const browser = await puppeteer.launch({
        headless: false,
        defaultViewport: null,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
        ],
    });

    const page = await browser.newPage();

    // â­ å¼ºçƒˆå»ºè®®åŠ  UA
    await page.setUserAgent(
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/122 Safari/537.36'
    );

    console.log('ğŸ‘‰ æ­£åœ¨æ‰“å¼€æŠ–éŸ³ï¼Œè¯·æ‰«ç ç™»å½•...');

    await page.goto('https://www.douyin.com', {
        waitUntil: 'domcontentloaded',
        timeout: 0, // â­ å…³é”®ï¼šç¦æ­¢è¶…æ—¶
    });

    // äººå·¥ç¡®è®¤ï¼ˆæœ€ç¨³ï¼‰
    await waitEnter();

    const cookies = await page.cookies();
    const netscape = toNetscapeCookie(cookies);

    fs.writeFileSync(COOKIE_FILE, netscape, 'utf8');

    console.log('\nğŸª Cookie å·²æˆåŠŸä¿å­˜ï¼š');
    console.log(COOKIE_FILE);

    await browser.close();
})();
